#include "keys.h"
/* Ganked from http://minirighi.sourceforge.net/html/group__KeyboardDriver.html */
static int lcase[128] = 
{
  0x0000,0x011B,0x0231,0x0332,0x0433,0x0534,0x0635,0x0736,0x0837,0x0938,0x0A39,0x0B30,0x0C2D,0x0D3D,0x0E08,0x0F09,
  0x1071,0x1177,0x1265,0x1372,0x1474,0x1579,0x1675,0x1769,0x186F,0x1970,0x1A5B,0x1B5D,0x1C0D,0x1D00,0x1E61,0x1F73,
  0x2064,0x2166,0x2267,0x2368,0x246A,0x256B,0x266C,0x273B,0x2827,0x2960,0x2A00,0x2B5C,0x2C7A,0x2D78,0x2E63,0x2F76,
  0x3062,0x316E,0x326D,0x332C,0x342E,0x352F,0x3600,0x372A,0x3800,0x3920,0x3A00,0x3B00,0x3C00,0x3D00,0x3E00,0x3F00,
  0x4000,0x4100,0x4200,0x4300,0x4400,0x4500,0x4600,0x4700,0x4800,0x4900,0x4A2D,0x4B00,0x4C00,0x4D00,0x4E2B,0x4F00,
  0x5000,0x5100,0x5200,0x5300,0x5400,0x5500,0x5600,0x8500,0x8600,0x0000,0x0000,0x5B00,0x5C00,0x5D00
};
static int ucase[128] = 
{
  0x0000,0x011B,0x0221,0x0340,0x0423,0x0524,0x0625,0x075E,0x0826,0x092A,0x0A28,0x0B29,0x0C5F,0x0D2B,0x0E08,0x0F00,
  0x1051,0x1157,0x1245,0x1352,0x1454,0x1559,0x1655,0x1749,0x184F,0x1950,0x1A7B,0x1B7D,0x1C0D,0x1D00,0x1E41,0x1F53,
  0x2044,0x2146,0x2247,0x2348,0x244A,0x254B,0x264C,0x273A,0x2822,0x297E,0x2A00,0x2B7C,0x2C5A,0x2D58,0x2E43,0x2F56,
  0x3042,0x314E,0x324D,0x333C,0x343E,0x353F,0x3600,0x372A,0x3800,0x3920,0x3A00,0x5400,0x5500,0x5600,0x5700,0x5800,
  0x5900,0x5A00,0x5B00,0x5C00,0x5D00,0x4500,0x4600,0x4700,0x4800,0x4900,0x4A2D,0x4B00,0x4C00,0x4D00,0x4E2B,0x4F00,
  0x5000,0x5100,0x5200,0x5300,0x5400,0x5500,0x5600,0x8700,0x8800,0x0000,0x0000,0x5B00,0x5C00,0x5D00
};
kbstate_t keyboard;
char scan2byte(char code, char mods)
{
    if (mods & 0x01)
        return (char)(ucase[code] & 0xFF);
    else
        return (char)(lcase[code] & 0xFF);
}
char handle_keypress(char byte)
{
    char up;
    char key;
    up = byte & 0x80;
    key = byte & ~0x80;
    /* Handle modifiers */
    if (key == 0x2A || key == 0x36)
    {
        if (!up)
            keyboard.mods |= 0x01;
        else
            keyboard.mods &= ~0x01;
        return 0x00;
    }
    else if (key == 0x1D)
    {
        if (!up)
            keyboard.mods |= 0x02;
        else
            keyboard.mods &= ~0x02;
        return 0x00;
    }
    else if (key == 0x38)
    {
        if (!up)
            keyboard.mods |= 0x04;
        else
            keyboard.mods &= ~0x04;
        return 0x00;
    }
    else if (!up) /* It's a single-strike key. */
    {
        return scan2byte(key, keyboard.mods);
    }
    else
    {
        return 0x00;
    }
}

